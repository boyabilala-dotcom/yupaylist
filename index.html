<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日常拾光 - 北歐鼠尾草綠記帳管家</title>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .font-serif {
            font-family: 'Noto Serif TC', serif;
        }
        /* 避免圖標渲染問題的微調 */
        svg {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 由於 Lucide 在 CDN 下的行為，我們手動建立一個簡單的圖標組件封裝
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (iconRef.current) {
                    // 使用 lucide.createIcons 來渲染特定的圖標
                    lucide.createIcons({
                        attrs: {
                            strokeWidth: 2,
                            width: size,
                            height: size,
                            class: className
                        },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);

            return <i data-lucide={name} ref={iconRef} className={className}></i>;
        };

        const TAIWAN_BANKS = [
            "國泰世華", "中國信託", "玉山銀行", "台新銀行", "台北富邦", 
            "第一銀行", "華南銀行", "兆豐銀行", "永豐銀行", "渣打銀行", "中華郵政", "連線銀行 (LINE Bank)"
        ];

        function App() {
            const [activeTab, setActiveTab] = useState('record');
            const [isRecordModalOpen, setIsRecordModalOpen] = useState(false);
            const [isWishModalOpen, setIsWishModalOpen] = useState(false);
            const [isAssetEditModalOpen, setIsAssetEditModalOpen] = useState(false);
            const [isTransferModalOpen, setIsTransferModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [assetEditType, setAssetEditType] = useState(null); 
            const [selectedAccountType, setSelectedAccountType] = useState('cash');
            const [notification, setNotification] = useState(null);
            const fileInputRef = useRef(null);

            const [settings, setSettings] = useState({
                cash: 0,
                salaryDay: 5,
                salaryAccount: 'b1', 
                lastSalaryMonth: '',
                banks: [{ id: 'b1', name: '預設銀行', balance: 0 }],
                cards: []
            });

            const [records, setRecords] = useState([]);
            const [wishes, setWishes] = useState([]);

            const totalCashBank = settings.cash + settings.banks.reduce((acc, b) => acc + (Number(b.balance) || 0), 0);
            const totalCardDebt = settings.cards.reduce((acc, c) => acc + (Number(c.currentDebt) || 0), 0);

            const today = new Date();
            const currentMonthStr = `${today.getFullYear()}-${today.getMonth() + 1}`;
            const isSalaryDue = today.getDate() >= settings.salaryDay && settings.lastSalaryMonth !== currentMonthStr;

            const showNotice = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const exportToCSV = () => {
                const headers = ["日期", "類型", "分類", "金額", "帳戶類型", "備註"];
                const rows = records.map(r => [
                    r.date, r.type === 'income' ? '收入' : '支出',
                    r.category, r.amount, r.accountType, r.note || ""
                ]);
                let csvContent = "\uFEFF" + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `日常拾光_帳務匯出_${new Date().toISOString().split('T')[0]}.csv`);
                link.click();
                showNotice("Excel CSV 檔案已匯出");
            };

            const handleImportCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n');
                    const newRecords = [];
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        if (cols.length < 4) continue;
                        newRecords.push({
                            id: Date.now() + i,
                            date: cols[0].trim(),
                            type: cols[1].trim() === '收入' ? 'income' : 'expense',
                            category: cols[2].trim(),
                            amount: Number(cols[3].trim()) || 0,
                            accountType: cols[4]?.trim() || 'cash',
                            note: cols[5]?.trim() || "",
                            installments: 1
                        });
                    }
                    if (newRecords.length > 0) {
                        setRecords(prev => [...newRecords, ...prev]);
                        showNotice(`成功匯入 ${newRecords.length} 筆紀錄`);
                    }
                };
                reader.readAsText(file);
                event.target.value = null;
            };

            const settleCreditCards = () => {
                const curDay = today.getDate();
                let updatedBanks = [...settings.banks];
                let settledInfo = [];
                let updatedCards = settings.cards.map(card => {
                    if (card.currentDebt > 0 && curDay >= card.billDay) {
                        const bankIdx = updatedBanks.findIndex(b => b.id === card.linkedBankId);
                        if (bankIdx !== -1 && updatedBanks[bankIdx].balance >= card.currentDebt) {
                            updatedBanks[bankIdx] = { 
                                ...updatedBanks[bankIdx], 
                                balance: updatedBanks[bankIdx].balance - card.currentDebt 
                            };
                            settledInfo.push(`${card.name}`);
                            return { ...card, currentDebt: 0 };
                        }
                    }
                    return card;
                });
                if (settledInfo.length > 0) {
                    setSettings(prev => ({ ...prev, banks: updatedBanks, cards: updatedCards }));
                    showNotice(`已自動結算：${settledInfo.join(', ')}`);
                } else {
                    showNotice("今日無需結算之帳單或餘額不足");
                }
            };

            const saveRecord = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const amount = Number(formData.get('amount'));
                const accType = formData.get('accountType');
                const accId = formData.get('accountId');
                const type = formData.get('type');
                const isIncome = type === 'income';

                setSettings(prev => {
                    let nextSettings = { ...prev };
                    if (accType === 'cash') nextSettings.cash = isIncome ? prev.cash + amount : prev.cash - amount;
                    else if (accType === 'bank') nextSettings.banks = prev.banks.map(b => b.id === accId ? { ...b, balance: isIncome ? b.balance + amount : b.balance - amount } : b);
                    else if (accType === 'credit') nextSettings.cards = prev.cards.map(c => c.id === accId ? { ...c, currentDebt: isIncome ? c.currentDebt - amount : c.currentDebt + amount } : c);
                    return nextSettings;
                });

                const data = {
                    id: editingItem?.id || Date.now(),
                    date: formData.get('date'),
                    category: formData.get('category'),
                    amount: amount,
                    type: type,
                    accountType: accType,
                    accountId: accId || null,
                    installments: Number(formData.get('installments') || 1),
                    note: formData.get('note')
                };

                if (editingItem) setRecords(records.map(r => r.id === editingItem.id ? data : r));
                else setRecords([data, ...records]);
                
                if (isIncome && data.category.includes('薪資')) setSettings(prev => ({ ...prev, lastSalaryMonth: currentMonthStr }));
                setIsRecordModalOpen(false);
                setEditingItem(null);
                showNotice("紀錄已保存");
            };

            const handleAssetSave = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                if (assetEditType === 'cash') setSettings({ ...settings, cash: Number(formData.get('amount')) });
                else if (assetEditType === 'bank') {
                    const newBank = { id: editingItem?.id || Date.now().toString(), name: formData.get('name'), balance: Number(formData.get('balance')) };
                    setSettings({...settings, banks: editingItem ? settings.banks.map(b => b.id === editingItem.id ? newBank : b) : [...settings.banks, newBank]});
                } else if (assetEditType === 'card') {
                    const newCard = { id: editingItem?.id || Date.now().toString(), name: formData.get('name'), billDay: Number(formData.get('billDay')), currentDebt: editingItem?.currentDebt || 0, linkedBankId: formData.get('linkedBankId') };
                    setSettings({...settings, cards: editingItem ? settings.cards.map(c => c.id === editingItem.id ? newCard : c) : [...settings.cards, newCard]});
                } else if (assetEditType === 'salary') {
                    setSettings({ ...settings, salaryDay: Number(formData.get('salaryDay')), salaryAccount: formData.get('salaryAccount') });
                }
                setIsAssetEditModalOpen(false);
                showNotice("資產設定已更新");
            };

            return (
                <div className="min-h-screen bg-[#F4F6F2] text-[#424B3E] pb-28 font-sans selection:bg-[#8BA888]/20">
                    {notification && (
                        <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[100] bg-[#424B3E] text-white px-6 py-3 rounded-full text-xs font-bold shadow-2xl animate-bounce">
                            {notification}
                        </div>
                    )}

                    <header className="px-6 pt-12 pb-6 flex justify-between items-end">
                        <div>
                            <p className="text-[#8BA888] text-[10px] font-black uppercase tracking-widest mb-1">Sage Life Ledger</p>
                            <h1 className="text-3xl font-serif font-black text-[#2F362E]">日常拾光</h1>
                        </div>
                        <div className="flex gap-2 items-center">
                            {isSalaryDue && (
                                <button onClick={() => { setEditingItem(null); setSelectedAccountType('bank'); setIsRecordModalOpen(true); }} className="p-3 bg-[#6B8E67] text-white rounded-2xl animate-pulse shadow-lg flex items-center gap-2">
                                    <Icon name="bell" size={18} />
                                    <span className="text-[10px] font-black">領薪提醒</span>
                                </button>
                            )}
                            <div className="w-10 h-10 bg-[#8BA888] rounded-full flex items-center justify-center text-white">
                                <Icon name="landmark" size={20} />
                            </div>
                        </div>
                    </header>

                    <main className="px-6 space-y-8">
                        {activeTab === 'record' && (
                            <div className="space-y-6">
                                <div className="bg-[#DDE5DB] p-8 rounded-[2.5rem] shadow-sm border border-[#C5D1C3] space-y-6">
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="space-y-1 border-r border-[#B8C7B5] pr-4">
                                            <p className="text-[10px] font-bold text-[#6B7C68] uppercase tracking-wider">流動資產</p>
                                            <p className="text-2xl font-black text-[#2F362E] tracking-tight">${totalCashBank.toLocaleString()}</p>
                                        </div>
                                        <div className="space-y-1 pl-2">
                                            <p className="text-[10px] font-bold text-[#6B7C68] uppercase tracking-wider">應繳負債</p>
                                            <p className="text-2xl font-black text-[#8B5E4F] tracking-tight">${totalCardDebt.toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t border-[#B8C7B5] space-y-3">
                                        <div className="flex justify-between items-center mb-2">
                                            <p className="text-[10px] font-bold text-[#6B7C68] uppercase tracking-wider">信用卡對帳</p>
                                            <button onClick={settleCreditCards} className="text-[10px] font-black bg-[#424B3E] text-white px-3 py-1.5 rounded-full hover:scale-95">
                                                自動扣帳
                                            </button>
                                        </div>
                                        {settings.cards.length > 0 ? settings.cards.map(card => (
                                            <div key={card.id} className="flex justify-between items-center bg-white/40 p-3 rounded-xl text-[11px] font-bold">
                                                <div className="flex items-center gap-2"><Icon name="credit-card" size={14} /><span>{card.name}</span></div>
                                                <span className={card.currentDebt > 0 ? 'text-[#8B5E4F]' : 'text-[#6B8E67]'}>${card.currentDebt.toLocaleString()}</span>
                                            </div>
                                        )) : <p className="text-[10px] text-center italic opacity-50">尚無信用卡資料</p>}
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-1">
                                        <h3 className="text-xs font-black text-[#6B7C68] uppercase tracking-widest">收支明細</h3>
                                        <div className="flex gap-3">
                                            <button onClick={exportToCSV} className="text-[#8BA888] hover:text-[#2F362E] flex items-center gap-1 text-[10px] font-black"><Icon name="download" size={12} /> 匯出</button>
                                            <button onClick={() => fileInputRef.current.click()} className="text-[#8BA888] hover:text-[#2F362E] flex items-center gap-1 text-[10px] font-black"><Icon name="upload" size={12} /> 匯入</button>
                                            <input type="file" ref={fileInputRef} onChange={handleImportCSV} accept=".csv" className="hidden" />
                                        </div>
                                    </div>
                                    {records.length > 0 ? records.map(record => (
                                        <div key={record.id} onClick={() => { setEditingItem(record); setSelectedAccountType(record.accountType); setIsRecordModalOpen(true); }} className="bg-white p-5 rounded-[2rem] border border-[#E3E8DF] flex justify-between items-center cursor-pointer hover:border-[#8BA888] transition-all">
                                            <div className="flex items-center gap-4">
                                                <div className={`w-10 h-10 rounded-2xl flex items-center justify-center ${record.type === 'expense' ? 'bg-[#F2F4F1]' : 'bg-[#EDF2EC] text-[#6B8E67]'}`}>
                                                    <Icon name={record.type === 'income' ? 'trending-up' : 'trending-down'} size={18} />
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-sm text-[#2F362E]">{record.category}</h4>
                                                    <p className="text-[9px] font-bold text-[#A4AE9F]">{record.date}</p>
                                                </div>
                                            </div>
                                            <p className={`font-black text-base ${record.type === 'expense' ? 'text-[#424B3E]' : 'text-[#6B8E67]'}`}>
                                                {record.type === 'expense' ? '-' : '+'}${record.amount.toLocaleString()}
                                            </p>
                                        </div>
                                    )) : <p className="text-center py-10 text-xs text-gray-400">目前沒有紀錄，點擊右下角開始記帳吧！</p>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'wish' && (
                            <div className="space-y-6">
                                <h3 className="text-xs font-black text-[#6B7C68] uppercase tracking-widest px-1">夢想清單</h3>
                                {wishes.map(wish => (
                                    <div key={wish.id} className={`p-6 rounded-[2.5rem] border ${wish.isAchieved ? 'bg-[#E9EDE7] opacity-60' : 'bg-white border-[#E3E8DF]'}`}>
                                        <div className="flex justify-between items-start">
                                            <div className="flex gap-4">
                                                <button onClick={() => setWishes(wishes.map(w => w.id === wish.id ? {...w, isAchieved: !w.isAchieved} : w))} className={wish.isAchieved ? 'text-[#6B8E67]' : 'text-[#CCD4C9]'}>
                                                    <Icon name="check-circle" size={24} />
                                                </button>
                                                <div>
                                                    <h4 className={`font-bold text-base ${wish.isAchieved ? 'line-through text-[#A4AE9F]' : ''}`}>{wish.name}</h4>
                                                    <p className="text-[10px] text-[#A4AE9F] font-bold">預計：{wish.targetDate}</p>
                                                </div>
                                            </div>
                                            <p className="font-black text-xl">${wish.price.toLocaleString()}</p>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => { setEditingItem(null); setIsWishModalOpen(true); }} className="w-full p-8 rounded-[2.5rem] border-2 border-dashed border-[#CCD4C9] text-[#6B7C68] font-bold text-xs flex items-center justify-center gap-2 hover:bg-white transition-colors">
                                    <Icon name="plus" size={18} /> 許下新的願景
                                </button>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-8">
                                <section className="bg-white p-6 rounded-[2.5rem] border border-[#E3E8DF] shadow-sm space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-xs font-black text-[#6B7C68] uppercase tracking-widest px-1">薪資入帳通知</h3>
                                        <button onClick={() => { setAssetEditType('salary'); setIsAssetEditModalOpen(true); }} className="text-[#8BA888] text-[10px] font-black underline">設定</button>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 bg-[#EDF2EC] rounded-2xl flex items-center justify-center text-[#6B8E67]"><Icon name="bell" size={24} /></div>
                                        <div><p className="font-bold text-sm">每月 {settings.salaryDay} 日提醒</p></div>
                                    </div>
                                </section>
                                <section className="space-y-4">
                                    <div className="flex justify-between items-center px-1">
                                        <h3 className="text-xs font-black text-[#6B7C68] uppercase tracking-widest">帳戶管理</h3>
                                    </div>
                                    <div className="bg-[#E9EDE7] p-6 rounded-[2.5rem] flex justify-between items-center shadow-sm">
                                        <div className="flex items-center gap-3"><Icon name="banknote" size={20} /><span className="font-bold text-sm">現金</span></div>
                                        <div className="flex items-center gap-3"><p className="font-black text-lg">${settings.cash.toLocaleString()}</p><button onClick={() => { setAssetEditType('cash'); setIsAssetEditModalOpen(true); }}><Icon name="edit-2" size={14} /></button></div>
                                    </div>
                                    {settings.banks.map(bank => (
                                        <div key={bank.id} className="bg-white p-6 rounded-[2.5rem] border border-[#E3E8DF] flex justify-between items-center shadow-sm">
                                            <div className="flex items-center gap-3"><Icon name="landmark" size={20} className="text-[#6B8E67]" /><span className="font-bold text-sm">{bank.name}</span></div>
                                            <div className="flex items-center gap-2"><span className="font-black text-lg">${bank.balance.toLocaleString()}</span><button onClick={() => { setEditingItem(bank); setAssetEditType('bank'); setIsAssetEditModalOpen(true); }}><Icon name="edit-2" size={14} /></button></div>
                                        </div>
                                    ))}
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => { setEditingItem(null); setAssetEditType('bank'); setIsAssetEditModalOpen(true); }} className="py-5 border-2 border-dashed border-[#CCD4C9] rounded-[2rem] text-[10px] font-black uppercase tracking-widest">+ 銀行</button>
                                        <button onClick={() => { setEditingItem(null); setAssetEditType('card'); setIsAssetEditModalOpen(true); }} className="py-5 border-2 border-dashed border-[#8BA888]/30 rounded-[2rem] text-[10px] font-black uppercase tracking-widest">+ 卡片</button>
                                    </div>
                                </section>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-10 left-8 right-8 bg-white/90 backdrop-blur-xl border border-[#E3E8DF] h-20 rounded-[3rem] flex items-center justify-around shadow-2xl z-40 overflow-hidden">
                        <button onClick={() => setActiveTab('record')} className={`flex flex-col items-center gap-1 ${activeTab === 'record' ? 'text-[#8BA888]' : 'text-[#CCD4C9]'}`}><Icon name="wallet" size={24} /><span className="text-[8px] font-black uppercase">帳目</span></button>
                        <button onClick={() => setActiveTab('wish')} className={`flex flex-col items-center gap-1 ${activeTab === 'wish' ? 'text-[#8BA888]' : 'text-[#CCD4C9]'}`}><Icon name="heart" size={24} /><span className="text-[8px] font-black uppercase">心願</span></button>
                        <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center gap-1 ${activeTab === 'settings' ? 'text-[#8BA888]' : 'text-[#CCD4C9]'}`}><Icon name="settings" size={24} /><span className="text-[8px] font-black uppercase">資產</span></button>
                    </nav>

                    {activeTab === 'record' && (
                        <button onClick={() => { setEditingItem(null); setSelectedAccountType('cash'); setIsRecordModalOpen(true); }} className="fixed bottom-36 right-8 w-16 h-16 bg-[#424B3E] text-white rounded-full shadow-2xl flex items-center justify-center z-30">
                            <Icon name="plus" size={32} />
                        </button>
                    )}

                    {isRecordModalOpen && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-end sm:items-center justify-center">
                            <form onSubmit={saveRecord} className="bg-white w-full max-w-lg rounded-t-[3rem] sm:rounded-[3rem] p-10 space-y-6">
                                <div className="flex justify-between items-center"><h2 className="text-xl font-black">記帳</h2><button type="button" onClick={() => setIsRecordModalOpen(false)}><Icon name="x" size={28} /></button></div>
                                <input name="amount" type="number" defaultValue={editingItem?.amount} placeholder="金額" className="w-full text-center text-5xl font-black outline-none border-b py-4" required />
                                <div className="grid grid-cols-2 gap-4">
                                    <select name="type" defaultValue={editingItem?.type || "expense"} className="bg-gray-50 p-4 rounded-2xl font-bold"><option value="expense">支出</option><option value="income">收入</option></select>
                                    <select name="accountType" value={selectedAccountType} onChange={(e) => setSelectedAccountType(e.target.value)} className="bg-gray-50 p-4 rounded-2xl font-bold"><option value="cash">現金</option><option value="bank">銀行</option><option value="credit">信用卡</option></select>
                                </div>
                                <input name="category" defaultValue={editingItem?.category} placeholder="分類 (如: 飲食)" className="w-full bg-gray-50 p-4 rounded-2xl font-bold" required />
                                <input name="date" type="date" defaultValue={editingItem?.date || today.toISOString().split('T')[0]} className="w-full bg-gray-50 p-4 rounded-2xl font-bold" required />
                                <button type="submit" className="w-full bg-[#8BA888] text-white font-black py-5 rounded-2xl shadow-xl">保存</button>
                            </form>
                        </div>
                    )}

                    {isAssetEditModalOpen && (
                        <div className="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-6">
                            <form onSubmit={handleAssetSave} className="bg-white w-full max-w-sm rounded-[3rem] p-10 space-y-6">
                                <h2 className="text-xl font-black">設定資產</h2>
                                {assetEditType === 'cash' && <input name="amount" type="number" defaultValue={settings.cash} className="w-full bg-gray-50 p-4 rounded-2xl font-bold" />}
                                {assetEditType === 'bank' && (
                                    <>
                                        <select name="name" defaultValue={editingItem?.name} className="w-full bg-gray-50 p-4 rounded-2xl font-bold">{TAIWAN_BANKS.map(b => <option key={b} value={b}>{b}</option>)}</select>
                                        <input name="balance" type="number" defaultValue={editingItem?.balance || 0} className="w-full bg-gray-50 p-4 rounded-2xl font-bold" />
                                    </>
                                )}
                                <button type="submit" className="w-full bg-[#8BA888] text-white font-black py-4 rounded-2xl">更新</button>
                                <button type="button" onClick={() => setIsAssetEditModalOpen(false)} className="w-full text-xs text-gray-400">取消</button>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
